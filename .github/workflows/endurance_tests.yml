name: Stability Tests

# ============================================================================
# WORKFLOW PURPOSE
# ============================================================================
# Comprehensive stability testing workflow for valkey-search using the
# Python-based stability test suite. Tests multiple scenarios including:
# - Multiple index types (FLAT, HNSW, TEXT, TAG, NUMERIC)
# - Concurrent operations with memtier_benchmark
# - Background stress tasks (BGSAVE, FT.CREATE, FT.DROPINDEX, FLUSHDB)
# - Optional failover testing with replicas
# ============================================================================

on:
  push:
    branches:
      - main
      - gitHubEndurRun
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Test filter pattern (e.g., "*hnsw*", "*text*", or "*" for all)'
        required: false
        default: '*'
        type: string
      test_duration:
        description: 'Test duration in seconds (for time-based tests)'
        required: false
        default: '60'
        type: string
  schedule:
    # Run daily at 9 AM UTC
    - cron: "0 9 * * *"

concurrency:
  group: stability-tests-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  stability-tests:
    runs-on: ubuntu-latest

    steps:
    # Checkout the code from the repository
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # Set up Docker to build and run the container
    - name: Set up Docker
      uses: docker/setup-buildx-action@v2

    # Build the Docker image
    - name: Build Docker Image
      run: |
        docker build -t stability-test-image -f .devcontainer/Dockerfile .
        echo "Verifying memtier-benchmark..."
        docker run --rm stability-test-image memtier_benchmark --version

    # Build valkey-search module
    - name: Build valkey-search Module
      run: |
        docker run --rm \
          -v "$(pwd):/valkey-search" \
          -w /valkey-search \
          --user "ubuntu:ubuntu" \
          stability-test-image \
          sudo -E ./build.sh

    # Run stability tests
    - name: Run Stability Tests
      run: |
        # Clean up any existing test build directory and pre-create with correct permissions
        sudo rm -rf testing/integration/.build-release
        mkdir -p testing/integration/.build-release
        chmod -R 777 testing/integration/.build-release
        docker run --rm \
          -v "$(pwd):/valkey-search" \
          -w /valkey-search \
          -e VALKEY_SEARCH_PATH="/valkey-search/.build-release/libsearch.so" \
          stability-test-image \
          ./testing/integration/run.sh --test stability

    # Update results permissions
    - name: Update Results Permissions
      if: always()
      run: sudo chmod -R 755 testing/integration/.build-release/output

    # Display logs and results on failure for debugging
    - name: Display Test Results
      if: failure()
      run: |
        echo "=== Displaying Test Results and Logs ==="
        echo ""
        echo "=== Results Directory Structure ==="
        ls -laR testing/integration/.build-release/output/ || echo "Results directory is empty or inaccessible"
        echo ""
        echo "=== Memtier JSON Results ==="
        find testing/integration/.build-release/output -name "*memtier*.json" -type f -exec echo "File: {}" \; -exec cat {} \; -exec echo "" \; || echo "No memtier results found"
        echo ""
        echo "=== Server Logs (last 500 lines each) ==="
        find testing/integration/.build-release/output -name "*.log" -type f -exec echo "File: {}" \; -exec tail -500 {} \; -exec echo "" \; || echo "No server logs found"
        echo ""
        echo "=== Test Output ==="
        find testing/integration/.build-release/output -name "*.txt" -type f -exec echo "File: {}" \; -exec cat {} \; -exec echo "" \; || echo "No test output files found"

    # Display summary on success
    - name: Display Success Summary
      if: success()
      run: |
        echo "=== Stability Tests Passed Successfully ==="
        echo ""
        echo "Test Filter: ${{ github.event.inputs.test_filter || '*' }}"
        echo "Results saved to: testing/integration/.build-release/output/"
        echo ""
        echo "=== Test Results Summary ==="
        find testing/integration/.build-release/output -name "*memtier*.json" -type f | head -5 || echo "No results found"

    # Upload test results as artifacts
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: stability-test-results-${{ github.run_number }}
        path: testing/integration/.build-release/output
        retention-days: 90

    # Upload server logs separately for easier access
    - name: Upload Server Logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: server-logs-${{ github.run_number }}
        path: testing/integration/.build-release/output/**/*.log
        retention-days: 30

  # Summary job to show test results
  test-summary:
    runs-on: ubuntu-latest
    needs: stability-tests
    if: always()
    steps:
      - name: Generate Test Summary
        run: |
          echo "## Stability Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.stability-tests.result }}" == "success" ]; then
            echo "✅ All stability tests passed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Stability tests failed. Check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Test Filter: ${{ github.event.inputs.test_filter || '*' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test Duration: ${{ github.event.inputs.test_duration || '60' }}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- Stability test results: stability-test-results-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Server logs: server-logs-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY