name: Stability Tests

# ============================================================================
# WORKFLOW PURPOSE
# ============================================================================
# Comprehensive stability testing workflow for valkey-search using the
# Python-based stability test suite. Tests multiple scenarios including:
# - Multiple index types (FLAT, HNSW, TEXT, TAG, NUMERIC)
# - Concurrent operations with memtier_benchmark
# - Background stress tasks (BGSAVE, FT.CREATE, FT.DROPINDEX, FLUSHDB)
# - Optional failover testing with replicas
# ============================================================================

on:
  push:
    branches:
      - main
      - gitHubEndurRun
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Test filter pattern (e.g., "*hnsw*", "*text*", or "*" for all)'
        required: false
        default: '*'
        type: string
      test_duration:
        description: 'Test duration in seconds (for time-based tests)'
        required: false
        default: '180'
        type: string
  schedule:
    # Run daily at 9 AM UTC
    - cron: "0 9 * * *"

concurrency:
  group: stability-tests-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  stability-tests:
    runs-on: [self-hosted, linux, ARM64]

    steps:
    # Checkout the code from the repository
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        repository: valkey-io/valkey-search
        ref: main
        submodules: recursive

    # Build valkey-search module directly on ARM64 host
    - name: Build valkey-search Module on ARM64
      run: |
        export CC=$(which gcc)
        export CXX=$(which g++)
        ./build.sh
        echo "=== Build completed ==="
        ls -lh .build-release/libsearch.so

    # Run stability tests directly on ARM64 host
    - name: Run Stability Tests
      run: |
        # Clean up test build directory
        mkdir -p testing/integration/.build-release
        chmod -R 755 testing/integration/.build-release
        
        # Set environment variable for module path
        export VALKEY_SEARCH_PATH="$(pwd)/.build-release/libsearch.so"
        
        # Run tests
        cd testing/integration
        ./run.sh --test stability

    # Update results permissions
    - name: Update Results Permissions
      if: always()
      run: chmod -R 755 testing/integration/.build-release/output || true

    # Upload test results as artifacts
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: stability-test-results-${{ github.run_number }}
        path: testing/integration/.build-release/output
        retention-days: 90

  # Cleanup job to remove temporary files and build artifacts
  cleanup:
    runs-on: [self-hosted, linux, ARM64]
    needs: stability-tests
    if: always()
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: valkey-io/valkey-search
          ref: main

      - name: Clean Build Directories
        run: |
          echo "=== Cleaning up build directories and temporary files ==="
          rm -rf .build-release
          rm -rf testing/integration/.build-release
          rm -rf build/
          echo "âœ“ Cleanup completed successfully"
