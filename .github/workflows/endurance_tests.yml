name: Endurance and Stability Tests

# ============================================================================
# WORKFLOW PURPOSE
# ============================================================================
# Endurance testing workflow using memtier_benchmark with TLS
# support for long-running performance and stability testing.
# ============================================================================

on:
  workflow_dispatch:
    inputs:
      server_type:
        description: 'Server type to test'
        required: false
        default: 'valkey'
        type: choice
        options:
          - valkey
          - redis
      branch_version:
        description: 'Branch/version to test'
        required: false
        default: 'unstable'
        type: string
      enable_tls:
        description: 'Enable TLS'
        required: false
        default: true
        type: boolean
      test_duration:
        description: 'Test duration in seconds'
        required: false
        default: '3600'
        type: string
      threads:
        description: 'Number of memtier threads'
        required: false
        default: '10'
        type: string
      clients:
        description: 'Number of memtier clients'
        required: false
        default: '10'
        type: string
      pipeline_depth:
        description: 'Pipeline depth'
        required: false
        default: '1'
        type: string
      data_size:
        description: 'Data size in bytes'
        required: false
        default: '1024'
        type: string
      workload_type:
        description: 'Workload type'
        required: false
        default: 'mixed'
        type: choice
        options:
          - mixed
          - read_only
          - write_only
      keyspace_size:
        description: 'Keyspace size'
        required: false
        default: '1000000'
        type: string
  push:
    branches:
      - main
      - enduranceGitHubRun
      - enduranceMemory
    paths:
      - 'src/**'
      - 'testing/**'
      - 'vmsdk/src/**'
      - 'vmsdk/testing/**'
      - '.github/workflows/**'
  schedule:
    - cron: "0 9 * * *" # Daily endurance tests at 2 AM UTC

concurrency:
  group: endurance-tests-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  endurance-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 7200
    

    steps:
    # Checkout the code from the repository
    - name: Checkout Code
      uses: actions/checkout@v4

    # Set up Docker to build and run the container
    - name: Set up Docker
      uses: docker/setup-buildx-action@v2

    # Build the Docker image from the Dockerfile in your repo
    - name: Build Docker Image
      run: |
        docker build -t endurance-test-image -f .devcontainer/Dockerfile .
        echo "Verifying memtier-benchmark..."
        docker run --rm endurance-test-image memtier_benchmark --version
        echo "Checking TLS support..."
        docker run --rm endurance-test-image bash -c \
          "memtier_benchmark --help | grep -q '\-\-tls' && echo 'TLS support confirmed' || echo 'WARNING: No TLS support'"

    - name: Create Results Directory
      run: |
        mkdir -p endurance-results
        mkdir -p tls
        chmod 777 endurance-results
        chmod 777 tls

    - name: Run Endurance Tests
      id: test-run
      timeout-minutes: 7200
      continue-on-error: true
      run: |
        docker run --privileged --rm \
          --mount type=bind,source="$(pwd)/endurance-results",target=/workspace/results \
          --mount type=bind,source="$(pwd)/tls",target=/workspace/tls \
          -v "$(pwd):/workspace" \
          -e SERVER_TYPE="${{ github.event.inputs.server_type || 'valkey' }}" \
          -e BRANCH_VERSION="${{ github.event.inputs.branch_version || 'unstable' }}" \
          -e ENABLE_TLS="${{ github.event.inputs.enable_tls != 'false' && 'true' || 'false' }}" \
          -e TEST_DURATION="${{ github.event.inputs.test_duration || '3600' }}" \
          -e REQUEST_COUNT="0" \
          -e THREADS="${{ github.event.inputs.threads || '10' }}" \
          -e CLIENTS="${{ github.event.inputs.clients || '10' }}" \
          -e PIPELINE_DEPTH="${{ github.event.inputs.pipeline_depth || '1' }}" \
          -e DATA_SIZE="${{ github.event.inputs.data_size || '1024' }}" \
          -e WORKLOAD_TYPE="${{ github.event.inputs.workload_type || 'mixed' }}" \
          -e KEYSPACE_SIZE="${{ github.event.inputs.keyspace_size || '1000000' }}" \
          --user "ubuntu:ubuntu" \
          endurance-test-image \
          sudo /workspace/scripts/benchmark/run_endurance_test.sh

    - name: Update Results Permissions
      if: always()
      run: sudo chmod -R 755 endurance-results

    # Upload test results as artifacts
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: endurance-test-results-${{ github.run_number }}
        path: endurance-results
        retention-days: 90

    # Fail the job if tests failed
    - name: Check Test Results
      if: steps.test-run.outcome == 'failure'
      run: exit 1
